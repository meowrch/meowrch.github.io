---
title: Советы по оптимизации системы
description: ...
---

# Загрузка системы
Для того, чтобы узнать, - какой процесс больше всего тормозит запуск системы, выполните команду `systemd-analyze blame`

Дайте угадаю, NetworkManager-wait-online оказался предателем, и отнимает от запуска вашей системы ~4 секунды? Не беда. Можете просто отключить его)
```bash
sudo systemctl mask NetworkManager-wait-online.service
```

# Ускорение распаковки initramfs
Это начальное загрузочное окружение, которое дополняет образ ядра Linux, включая все необходимые модули и утилиты для его загрузки, особенно для монтирования корневого раздела. Для экономии места оно представляется в виде саморасжимаемого архива, который распаковывается во время загрузки. В Arch Linux утилита mkinitcpio создает initramfs и по умолчанию использует алгоритм сжатия zstd, оптимальный по скорости. Однако для ускорения загрузки лучше применить алгоритм lz4, который обеспечивает более быструю распаковку. 

Чтобы установить lz4 в качестве алгоритма сжатия для initramfs, нужно отредактировать файл /etc/mkinitcpio.conf, добавив следующие строки:
```ini
COMPRESSION="lz4"
COMPRESSION_OPTIONS=(-9)
```

Дополнительно можно ускорить загрузку, заменив хуки base и udev на systemd в том же конфигурационном файле. Это приведет к увеличению размера initramfs, но может сократить время загрузки на несколько секунд:
```ini
HOOKS=(systemd autodetect microcode modconf kms keyboard sd-vconsole block filesystems fsck)
```

> [!WARNING]
> Для систем с зашифрованным корневым разделом к представленному перечню хуков вам также следует добавить sd-encrypt через пробел сразу после хука sd-vconsole.

После внесения изменений обновите образы initramfs с помощью команды:
```bash
sudo mkinitcpio -P
```


# Флаги компиляции
Флаги компиляции являются указателями для компилятора, какие инструкции и оптимизации использовать при сборке программ. 

Для оптимизации процесса сборки мы можем их изменить, создав пользовательский конфиг `~/.makepkg.conf` в домашней директории, чтобы переопределить системные настройки:
```ini
CFLAGS="-march=native -mtune=native -O2 -pipe -fno-plt -fexceptions \
      -Wp,-D_FORTIFY_SOURCE=3 -Wformat -Werror=format-security \
      -fstack-clash-protection -fcf-protection"
CXXFLAGS="$CFLAGS -Wp,-D_GLIBCXX_ASSERTIONS"
RUSTFLAGS="-C opt-level=3 -C target-cpu=native -C link-arg=-z -C link-arg=pack-relative-relocs"
MAKEFLAGS="-j$(nproc) -l$(nproc)"
```

> [!WARNING]
> Данные флаги компилятора выжимают максимум производительности при компиляции, но могут вызывать ошибки сборки в очень редких приложениях. Если такое случится, то отключите параметр ‘lto’ в строке options добавив перед ним символ восклицательного знака ! ("!lto").

# Ccache
В Linux есть программы, сборка которых может занять более двух часов, и для ускорения повторной компиляции таких приложений, как Wine или Proton-GE, можно использовать ccache.

Ccache — это кэш для компиляторов C/C++, совместимый с GCC и Clang, который ускоряет повторную компиляцию одного и того же кода. Если при сборке новой версии программы обнаруживаются идентичные блоки исходного кода, ccache использует уже скомпилированный код из кэша, что значительно ускоряет процесс компиляции.

Для его установки выполните следующие команды:
```
sudo pacman -S ccache
```

После установки его ещё нужно активировать в ваших настройках makepkg. Для этого отредактируем конфигурационный файл `~/.makepkg.conf`, добавив следующие конфигурации:
```ini
BUILDENV=(!distcc color ccache check !sign)
```

> [!WARNING]
> ccache может ломать сборку некоторых программ, поэтому будьте осторожны с его применением.


# TRIM 
Это команда, используемая в твердотельных накопителях (SSD), которая позволяет операционной системе сообщить накопителю, какие блоки данных больше не нужны и могут быть очищены. Это помогает поддерживать производительность SSD, предотвращая замедление работы при записи данных.

Чтобы его включить, выполните следующие команды:
```
sudo systemctl enable fstrim.timer
sudo fstrim -v /
```

> [!WARNING]
> Если вы используйте файловую систему Btrfs и имеете версию ядра 6.2 и выше, то выполнять включение службы для осуществления периодическего выполнения команды TRIM - не нужно, т. к. Btrfs сам выполняет её в асинхронном режиме.

# OOM
Out-Of-Memory Killer (OOM) — это процесс в Linux, который завершает приложение, чтобы спасти ядро от сбоя. Он жертвует приложением, чтобы сохранить работу ОС.

Для того, чтобы его включить, выполните команду:
```bash
sudo systemctl enable --now systemd-oomd
```


# Ananicy CPP
[Ananicy](https://github.com/Nefelim4ag/Ananicy) - это демон для распределения приоритета задач, его установка сильно повышает отклик системы.

Но мы будем устанавливать его форк, а именно [Ananicy CPP](https://gitlab.com/ananicy-cpp/ananicy-cpp).
В отличии от оригинального Ananicy, данный форк переписан полностью на C++, из-за чего достигается прирост в скорости работы.

Для его установки выполните следующие команды:
```bash
git clone https://aur.archlinux.org/ananicy-cpp.git
cd ananicy-cpp  
makepkg -sric 
sudo systemctl enable --now ananicy-cpp
```

Так-же советую установить дополнительные правила по перераспределению приоритетов процессов
```bash
git clone https://aur.archlinux.org/cachyos-ananicy-rules-git.git
cd cachyos-ananicy-rules-git
makepkg -sric
sudo systemctl restart ananicy-cpp
```


# Haveged
Так-же могу посоветовать пакет [Haveged](https://wiki.archlinux.org/title/Haveged_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)).
Это демон, что следит на энтропией системы. Необходим для ускорения запуска системы при высоких показателях systemd-analyze blame (Больше 1 секунды).

Для его установки выполните следующие команды:
```bash
sudo pacman -S haveged 
sudo systemctl enable haveged
```

# Rng-tools
[Rng-tools](https://wiki.archlinux.org/title/Rng-tools) - демон, что также следит на энтропией системы, но, в отличие от haveged, через аппаратный таймер. Необходим для ускорения запуска системы при высоких показателях systemd-analyze blame (Больше 1 секунды).

Для его установки выполните следующие команды:
```bash
sudo pacman -S rng-tools
sudo systemctl enable --now rngd
```

> [!WARNING]
> Не использовать вместе с Ananicy

# Cpu Power
По умолчанию процессор динамически меняет свою частоту, что в принципе правильно и даёт баланс между энергосбережением и производительностью, но если вы всё-таки хотите выжать все соки, то необходимо закрепить режим максимальной производительности.

Для его установки выполните следующие команды:
```bash
sudo pacman -S cpupower
sudo cpupower frequency-set -g performance
```

Настройте конфигурацию cpupower

```bash
sudo nano /etc/default/cpupower
```

Отредактируйте строчку `governor=’performance’` и включите службу
```bash
sudo systemctl enable cpupower
```

# Auto CpuFreq
Это утилита для Linux, предназначенная для автоматической оптимизации скорости работы процессора и энергопотребления. Она активно следит за состоянием аккумулятора, загрузкой процессора, температурой и общей нагрузкой системы, что позволяет динамически переключаться между режимами энергосбережения и высокой производительности. Является пожалуй наилучшим вариантом.

Для его установки выполните следующие команды:
```bash
yay -S auto-cpufreq
sudo systemctl enable --now auto-cpufreq
```

# Оптимизация загрузки ядра
Вы можете немного изменить параметры загрузки ядра в GRUB, измените следующую строку в `/etc/default/grub`, добавив следующие параметры к своим:
```ini
GRUB_CMDLINE_LINUX_DEFAULT="... loglevel=2 nowatchdog split_lock_detect=off processor.ignore_ppc=1 migrations=off msr.allow_writes=on pcie_aspm=force module.sig_unenforce cryptomgr.notests initcall_debug no_timer_check noreplace-smp page_alloc.shuffle=1 rcupdate.rcu_expedited=1 tsc=reliable ..."
```
И наконец обновляем grub 
```bash
sudo grub-mkconfig -o /boot/grub/grub.cfg
```

> [!WARNING]
> Изменения параметров загрузки ядра в GRUB могут повлиять на безопасность и общее поведение системы. Выполняйте это на свой страх и риск.
>
> Влияние на безопасность
>    Отключение механизмов безопасности:
>        Параметры, такие как nowatchdog и `split_lock_detect=off`, могут снизить уровень защиты от зависаний и конфликтов, что потенциально может быть использовано злоумышленниками для атаки на систему.
>       Например, отключение `watchdog` может позволить системе зависнуть без автоматической перезагрузки, что дает возможность атакующим получить доступ к системе.
>    Игнорирование определенных проверок:
>        Параметр `module.sig_unenforce` отключает проверку подписи модулей ядра, что позволяет загружать неподписанные модули. Это может быть рискованным, так как неподписанные модули могут содержать вредоносный код.
>
>    Упрощение доступа к системе:
>        Отключение параметров, таких как `rcupdate.rcu_expedited=1`, может привести к менее эффективной обработке процессов в многопоточных средах, что также может быть использовано для атаки.
>
>Влияние на производительность
>   Оптимизация работы системы:
>        Параметры, такие как `pcie_aspm=force` и `page_alloc.shuffle=1`, могут улучшить производительность и управление энергопотреблением системы, что особенно важно для мобильных устройств.
>    Улучшение стабильности:
>        Параметры вроде `tsc=reliable` помогают обеспечить более точную синхронизацию времени на многоядерных системах, что может повысить стабильность работы приложений.
>    Управление процессами:
>        Отключение миграции процессов с помощью `migrations=off` может улучшить производительность в некоторых сценариях, но также может привести к ухудшению распределения нагрузки между ядрами

# Хочешь ещё больше?
Советую посетить [данный репозиторий](https://github.com/ventureoo/ARU). 
В нём собраны все способы оптимизации Arch linux.