---
title: Советы по оптимизации системы
description: ...
slug: ru/2.0/optimization/optimizing
---

import { Steps, FileTree } from '@astrojs/starlight/components';

# Загрузка системы
Для того, чтобы узнать, - какой процесс больше всего тормозит запуск системы, выполните команду `systemd-analyze blame`

Дайте угадаю, NetworkManager-wait-online оказался предателем, и отнимает от запуска вашей системы ~4 секунды? Не беда. Можете просто отключить его)
```bash
sudo systemctl mask NetworkManager-wait-online.service
```

# Ускорение распаковки initramfs

Это начальное загрузочное окружение, которое дополняет образ ядра Linux. Для экономии места оно представляется в виде саморасжимаемого архива. В Arch Linux утилита mkinitcpio создает initramfs и по умолчанию использует алгоритм сжатия zstd. Для ускорения загрузки лучше применить алгоритм lz4.

<Steps>

1. **Изменение алгоритма сжатия**
   
   Отредактируйте файл `/etc/mkinitcpio.conf`, добавив следующие строки:
   ```ini
   COMPRESSION="lz4"
   COMPRESSION_OPTIONS=(-9)
   ```

2. **Замена хуков на systemd (опционально)**
   
   Для дополнительного ускорения замените хуки base и udev на systemd:
   ```ini
   HOOKS=(systemd autodetect microcode modconf kms keyboard sd-vconsole block filesystems fsck)
   ```
   
   :::caution[Внимание]
   Для систем с зашифрованным корневым разделом добавьте `sd-encrypt` после хука `sd-vconsole`.
   :::

3. **Обновление образов initramfs**
   
   После внесения изменений выполните команду:
   ```bash
   sudo mkinitcpio -P
   ```

</Steps>


# Флаги компиляции
Флаги компиляции являются указателями для компилятора, какие инструкции и оптимизации использовать при сборке программ. 

Для оптимизации процесса сборки мы можем их изменить, создав пользовательский конфиг `~/.makepkg.conf` в домашней директории, чтобы переопределить системные настройки:
```ini
CFLAGS="-march=native -mtune=native -O2 -pipe -fno-plt -fexceptions \
      -Wp,-D_FORTIFY_SOURCE=3 -Wformat -Werror=format-security \
      -fstack-clash-protection -fcf-protection"
CXXFLAGS="$CFLAGS -Wp,-D_GLIBCXX_ASSERTIONS"
RUSTFLAGS="-C opt-level=3 -C target-cpu=native -C link-arg=-z -C link-arg=pack-relative-relocs"
MAKEFLAGS="-j$(nproc) -l$(nproc)"
```

:::caution[Важно]
Данные флаги компилятора выжимают максимум производительности при компиляции, но могут вызывать ошибки сборки в очень редких приложениях. Если такое случится, то отключите параметр 'lto' в строке options добавив перед ним символ восклицательного знака ! ("!lto").
:::

# Ccache
В Linux есть программы, сборка которых может занять более двух часов, и для ускорения повторной компиляции таких приложений, как Wine или Proton-GE, можно использовать ccache.

Ccache — это кэш для компиляторов C/C++, совместимый с GCC и Clang, который ускоряет повторную компиляцию одного и того же кода. Если при сборке новой версии программы обнаруживаются идентичные блоки исходного кода, ccache использует уже скомпилированный код из кэша, что значительно ускоряет процесс компиляции.

Для его установки выполните следующие команды:
```
sudo pacman -S ccache
```

После установки его ещё нужно активировать в ваших настройках makepkg. Для этого отредактируем конфигурационный файл `~/.makepkg.conf`, добавив следующие конфигурации:
```ini
BUILDENV=(!distcc color ccache check !sign)
```

:::caution[Внимание]
ccache может ломать сборку некоторых программ, поэтому будьте осторожны с его применением.
:::


# TRIM 
Это команда, используемая в твердотельных накопителях (SSD), которая позволяет операционной системе сообщить накопителю, какие блоки данных больше не нужны и могут быть очищены. Это помогает поддерживать производительность SSD, предотвращая замедление работы при записи данных.

Чтобы его включить, выполните следующие команды:
```
sudo systemctl enable fstrim.timer
sudo fstrim -v /
```

:::caution[Btrfs пользователям]
Если вы используйте файловую систему Btrfs и имеете версию ядра 6.2 и выше, то выполнять включение службы для осуществления периодическего выполнения команды TRIM - не нужно, т. к. Btrfs сам выполняет её в асинхронном режиме.
:::

# OOM
Out-Of-Memory Killer (OOM) — это процесс в Linux, который завершает приложение, чтобы спасти ядро от сбоя. Он жертвует приложением, чтобы сохранить работу ОС.

Для того, чтобы его включить, выполните команду:
```bash
sudo systemctl enable --now systemd-oomd
```


# Ananicy CPP

[Ananicy](https://github.com/Nefelim4ag/Ananicy) - это демон для распределения приоритета задач, который сильно повышает отклик системы. Мы будем устанавливать его форк [Ananicy CPP](https://gitlab.com/ananicy-cpp/ananicy-cpp), переписанный на C++ для увеличения производительности.

<Steps>

1. **Установка Ananicy CPP**
   
   Клонирование и сборка пакета из AUR:
   ```bash
   git clone https://aur.archlinux.org/ananicy-cpp.git
   cd ananicy-cpp
   makepkg -sric
   ```

2. **Активация службы**
   
   Включите и запустите службу:
   ```bash
   sudo systemctl enable --now ananicy-cpp
   ```

3. **Установка дополнительных правил (рекомендуется)**
   
   Установите расширенные правила для лучшей оптимизации:
   ```bash
   git clone https://aur.archlinux.org/cachyos-ananicy-rules-git.git
   cd cachyos-ananicy-rules-git
   makepkg -sric
   ```

4. **Перезапуск службы**
   
   Перезапустите службу для применения новых правил:
   ```bash
   sudo systemctl restart ananicy-cpp
   ```

</Steps>


# Haveged
Так-же могу посоветовать пакет [Haveged](https://wiki.archlinux.org/title/Haveged_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)).
Это демон, что следит на энтропией системы. Необходим для ускорения запуска системы при высоких показателях systemd-analyze blame (Больше 1 секунды).

Для его установки выполните следующие команды:
```bash
sudo pacman -S haveged 
sudo systemctl enable haveged
```

# Rng-tools
[Rng-tools](https://wiki.archlinux.org/title/Rng-tools) - демон, что также следит на энтропией системы, но, в отличие от haveged, через аппаратный таймер. Необходим для ускорения запуска системы при высоких показателях systemd-analyze blame (Больше 1 секунды).

Для его установки выполните следующие команды:
```bash
sudo pacman -S rng-tools
sudo systemctl enable --now rngd
```

:::caution[Внимание]
Не использовать вместе с Ananicy
:::

# Cpu Power

По умолчанию процессор динамически меняет свою частоту, что правильно и даёт баланс между энергосбережением и производительностью. Однако для максимальной производительности можно закрепить режим максимальной частоты.

<Steps>

1. **Установка утилиты CPUPower**
   ```bash
   sudo pacman -S cpupower
   ```

2. **Установка режима производительности**
   ```bash
   sudo cpupower frequency-set -g performance
   ```

3. **Настройка конфигурации**
   
   Откройте файл конфигурации:
   ```bash
   sudo nano /etc/default/cpupower
   ```
   
   Найдите и отредактируйте строку:
   ```ini
   governor='performance'
   ```

4. **Активация службы**
   ```bash
   sudo systemctl enable cpupower
   ```

</Steps>

# Auto CpuFreq

Это утилита для автоматической оптимизации скорости работы процессора и энергопотребления. Она следит за состоянием аккумулятора, загрузкой процессора, температурой и общей нагрузкой системы, динамически переключаясь между режимами энергосбережения и высокой производительности.

:::tip[Рекомендация]
Является наилучшим вариантом для большинства пользователей.
:::

<Steps>

1. **Установка из AUR**
   ```bash
   yay -S auto-cpufreq
   ```

2. **Активация службы**
   ```bash
   sudo systemctl enable --now auto-cpufreq
   ```

</Steps>

# Оптимизация загрузки ядра
Вы можете немного изменить параметры загрузки ядра в GRUB, измените следующую строку в `/etc/default/grub`, добавив следующие параметры к своим:
```ini
GRUB_CMDLINE_LINUX_DEFAULT="... loglevel=2 nowatchdog split_lock_detect=off processor.ignore_ppc=1 migrations=off msr.allow_writes=on pcie_aspm=force module.sig_unenforce cryptomgr.notests initcall_debug no_timer_check noreplace-smp page_alloc.shuffle=1 rcupdate.rcu_expedited=1 tsc=reliable ..."
```
И наконец обновляем grub 
```bash
sudo grub-mkconfig -o /boot/grub/grub.cfg
```

:::danger[Осторожно!]
Изменения параметров загрузки ядра в GRUB могут повлиять на безопасность и общее поведение системы. **Выполняйте это на свой страх и риск.**

**Влияние на безопасность:**
- **Отключение механизмов безопасности**: `nowatchdog` и `split_lock_detect=off` снижают защиту от зависаний
- **Игнорирование проверок**: `module.sig_unenforce` позволяет загружать неподписанные модули

**Влияние на производительность:**
- **Оптимизация системы**: `pcie_aspm=force` и `page_alloc.shuffle=1` улучшают производительность
- **Стабильность**: `tsc=reliable` обеспечивает лучшую синхронизацию
:::

# Хочешь ещё больше?
Советую посетить [данный репозиторий](https://github.com/ventureoo/ARU). 
В нём собраны все способы оптимизации Arch linux.