---
title: Tips for optimizing the system
description: ...
---

import { Steps, FileTree } from '@astrojs/starlight/components';

# System boot
To find out which process is slowing down your system startup the most, run the `systemd-analyze blame` command

Let me guess, NetworkManager-wait-online has turned out to be a traitor and is taking ~4 seconds off your system startup? No problem. You can just disable it)
```bash
sudo systemctl mask NetworkManager-wait-online.service
```

# Speeding up initramfs unpacking

This is the initial boot environment that completes the Linux kernel image. To save space, it is presented as a self-extracting archive. In Arch Linux, the mkinitcpio utility creates initramfs and by default uses the zstd compression algorithm. To speed up loading, it is better to use the lz4 algorithm.

<Steps>

1. **Change compression algorithm**
   
   Edit the `/etc/mkinitcpio.conf` file, adding the following lines:
   ```ini
   COMPRESSION="lz4"
   COMPRESSION_OPTIONS=(-9)
   ```

2. **Replace hooks with systemd (optional)**
   
   For additional acceleration, replace base and udev hooks with systemd:
   ```ini
   HOOKS=(systemd autodetect microcode modconf kms keyboard sd-vconsole block filesystems fsck)
   ```
   
   :::caution[Attention]
   For systems with an encrypted root partition, add `sd-encrypt` after the `sd-vconsole` hook.
   :::

3. **Update initramfs images**
   
   After making changes, run the command:
   ```bash
   sudo mkinitcpio -P
   ```

</Steps>


# Compilation flags
Compilation flags are pointers for the compiler on what instructions and optimizations to use when building programs. 

To optimize the build process, we can change them by creating a custom `~/.makepkg.conf` config in the home directory to override system settings:
```ini
CFLAGS="-march=native -mtune=native -O2 -pipe -fno-plt -fexceptions \
      -Wp,-D_FORTIFY_SOURCE=3 -Wformat -Werror=format-security \
      -fstack-clash-protection -fcf-protection"
CXXFLAGS="$CFLAGS -Wp,-D_GLIBCXX_ASSERTIONS"
RUSTFLAGS="-C opt-level=3 -C target-cpu=native -C link-arg=-z -C link-arg=pack-relative-relocs"
MAKEFLAGS="-j$(nproc) -l$(nproc)"
```

:::caution[Important]
These compiler flags maximize compilation performance, but may cause build errors in very rare applications. If this happens, disable the 'lto' parameter in the options line by adding an exclamation mark character in front of it ! ("!lto").
:::

# Ccache
Linux has programs that can take more than two hours to build, and ccache can be used to speed up the recompilation of applications such as Wine or Proton-GE.

Ccache is a cache for C/C++ compilers, compatible with GCC and Clang, that speeds up recompilation of the same code. If identical blocks of source code are found when building a new version of a program, ccache uses already compiled code from the cache, which greatly speeds up the compilation process.

To install it, run the following commands:
```
sudo pacman -S ccache
```

After installation, it still needs to be activated in your makepkg settings. To do this, edit the `~/.makepkg.conf` configuration file by adding the following configurations:
```ini
BUILDENV=(!distcc color ccache check !sign)
```

:::caution[Warning]
ccache can break the build of some programs, so be careful with its use.
:::


# TRIM 
This is a command used in solid state drives (SSDs) that allows the operating system to tell the drive which data blocks are no longer needed and can be cleared. This helps maintain SSD performance by preventing the SSD from slowing down when writing data.

To enable it, run the following commands:
```
sudo systemctl enable fstrim.timer
sudo fstrim -v /
```

:::caution[Btrfs Users]
If you use the Btrfs file system and have kernel version 6.2 or higher, you do not need to enable the service to periodically execute the TRIM command, because Btrfs itself executes it asynchronously.
:::

# OOM
Out-Of-Memory Killer (OOM) is a Linux process that terminates an application to save the kernel from crashing. It sacrifices the application to keep the OS running.

To enable it, run the command:
```bash
sudo systemctl enable --now systemd-oomd
```


# Ananicy CPP

[Ananicy](https://github.com/Nefelim4ag/Ananicy) is a task prioritization daemon that greatly improves system responsiveness. We will install [Ananicy CPP](https://gitlab.com/ananicy-cpp/ananicy-cpp), rewritten in C++ for increased performance.

<Steps>

1. **Install Ananicy CPP**
   
   Clone and build the package from AUR:
   ```bash
   git clone https://aur.archlinux.org/ananicy-cpp.git
   cd ananicy-cpp
   makepkg -sric
   ```

2. **Enable the service**
   
   Enable and start the service:
   ```bash
   sudo systemctl enable --now ananicy-cpp
   ```

3. **Install additional rules (recommended)**
   
   Install extended rules for better optimization:
   ```bash
   git clone https://aur.archlinux.org/cachyos-ananicy-rules-git.git
   cd cachyos-ananicy-rules-git
   makepkg -sric
   ```

4. **Restart the service**
   
   Restart the service to apply new rules:
   ```bash
   sudo systemctl restart ananicy-cpp
   ```

</Steps>

# Haveged
I can also recommend the package [Haveged](https://wiki.archlinux.org/title/Haveged_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)).
This is a daemon that monitors the entropy of the system. It is needed to speed up system startup at high systemd-analyze blame (More than 1 second).

To install it, run the following commands:
```bash
sudo pacman -S haveged 
sudo systemctl enable haveged
```

# Rng-tools
[Rng-tools](https://wiki.archlinux.org/title/Rng-tools) - a daemon that also monitors system entropy, but, unlike haveged, via a hardware timer. It is needed to speed up system startup at high systemd-analyze blame (More than 1 second).

To install it, run the following commands:
```bash
sudo pacman -S rng-tools
sudo systemctl enable --now rngd
```

:::caution[Warning]
Not to be used in conjunction with Ananicy CPP
:::

# Cpu Power

By default, the processor dynamically changes its frequency, which provides a balance between power saving and performance. However, for maximum performance, you can lock the maximum frequency mode.

<Steps>

1. **Install CPUPower utility**
   ```bash
   sudo pacman -S cpupower
   ```

2. **Set performance mode**
   ```bash
   sudo cpupower frequency-set -g performance
   ```

3. **Configure settings**
   
   Open the configuration file:
   ```bash
   sudo nano /etc/default/cpupower
   ```
   
   Find and edit the line:
   ```ini
   governor='performance'
   ```

4. **Enable the service**
   ```bash
   sudo systemctl enable cpupower
   ```

</Steps>

# Auto CpuFreq

This is a utility for automatically optimizing CPU speed and power consumption. It monitors battery status, CPU utilization, temperature and system load, dynamically switching between power saving and high performance modes.

:::tip[Recommendation]
This is the best option for most users.
:::

<Steps>

1. **Install from AUR**
   ```bash
   yay -S auto-cpufreq
   ```

2. **Enable the service**
   ```bash
   sudo systemctl enable --now auto-cpufreq
   ```

</Steps>

# Optimizing kernel loading
You can change the kernel boot parameters in GRUB a bit, change the following line in `/etc/default/grub` adding the following parameters to your own:
```ini
GRUB_CMDLINE_LINUX_DEFAULT="... loglevel=2 nowatchdog split_lock_detect=off processor.ignore_ppc=1 migrations=off msr.allow_writes=on pcie_aspm=force module.sig_unenforce cryptomgr.notests initcall_debug no_timer_check noreplace-smp page_alloc.shuffle=1 rcupdate.rcu_expedited=1 tsc=reliable ..."
```
And finally update grub 
```bash
sudo grub-mkconfig -o /boot/grub/grub.cfg
```

:::danger[Careful!]
Changes to kernel boot parameters in GRUB can affect security and overall system behavior. **Do so at your own risk.**

**Impact on Safety:**
- **Disabling safety mechanisms**: `nowatchdog` and `split_lock_detect=off` reduce protection against hangs
- **Ignoring checks**: `module.sig_unenforce` allows loading unsigned modules

**Impact on Performance:**
- **System optimization**: `pcie_aspm=force` and `page_alloc.shuffle=1` improve performance
- **Stability**: `tsc=reliable` provides better time synchronization
:::

# You want more?
I suggest you visit [this repo](https://github.com/ventureoo/ARU). 
It contains all the ways to optimize Arch linux.